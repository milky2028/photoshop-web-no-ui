<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Photoshop Web Booter</title>
    <style>
      body {
        display: grid;
        justify-items: start;
        row-gap: 0.5rem;
      }

      * {
        font-family: Arial, Helvetica, sans-serif;
      }

      .divider {
        width: 100%;
        height: 2px;
        background-color: black;
      }
    </style>
  </head>
  <body>
    <div class="divider"></div>
    <div><strong>Status: </strong><span id="status">uninitialized</span></div>
    <div>
      <strong>Cross Origin Isolated: </strong><span id="isolated">...</span>
    </div>
    <div class="divider"></div>
    <div>
      This application allows you to step through Photoshop Web's booting
      process with a pre-configured memory amount.
      <br />
      Use the checkbox next to each step to configure that step to run
      automatically on page reload.
    </div>
    <button id="clear-autoboot">Clear Autoboot</button>
    <div class="divider"></div>
    <label>
      <div>
        Initial WebAssembly Memory Allotment:
        <span id="configured-memory">...</span>GB
      </div>
      <input style="width: 300px" type="range" min="1" max="3.75" step="0.25" />
    </label>
    <div class="divider"></div>
    <div>Boot Process</div>
    <div>
      <input id="auto-glue" type="checkbox" />
      <button id="load-glue">Load Emscripten JS Glue Code</button>
      <span id="glue-status"></span>
    </div>
    <div>
      <input id="auto-wasm" type="checkbox" />
      <button id="load-wasm">Load WASM</button>
      <span id="wasm-status"></span>
    </div>
    <div>
      <input id="auto-canvas" type="checkbox" />
      <button id="load-canvas">Create and Attach Canvas</button>
      <span id="canvas-status"></span>
    </div>
    <div>
      <input id="auto-file" type="checkbox" />
      <button id="load-file">Import File</button>
      <span id="file-status"></span>
    </div>
    <div>
      <input id="auto-stroke" type="checkbox" />
      <button id="load-stroke">Draw Brushstroke</button>
      <span id="stroke-status"></span>
    </div>
    <div class="divider"></div>
    <script type="module">
      const DEFAULT_AUTOBOOT_CONFIG = {
        "auto-glue": false,
        "auto-wasm": false,
        "auto-canvas": false,
        "auto-file": false,
        "auto-stroke": false,
        "auto-memory": 2,
      };

      const AUTOBOOT_KEY = "autoboot";
      const storedAutobootConfig = localStorage.getItem(AUTOBOOT_KEY);
      const autobootConfig = storedAutobootConfig
        ? JSON.parse(storedAutobootConfig)
        : { ...DEFAULT_AUTOBOOT_CONFIG };

      const isolation = document.querySelector("#isolated");
      isolation.textContent = crossOriginIsolated;

      const memory = document.querySelector(`input[type="range"]`);
      const configuredMemory = document.querySelector("#configured-memory");

      memory.value = autobootConfig["auto-memory"];
      configuredMemory.textContent = memory.value;
      memory.addEventListener("input", (event) => {
        configuredMemory.textContent = event.target.value;
        autobootConfig["auto-memory"] = event.target.value;
        localStorage.setItem(AUTOBOOT_KEY, JSON.stringify(autobootConfig));
      });

      const COMPLETE = " - ✅";
      const FAILED = " - ❌";
      const glueStatus = document.querySelector("#glue-status");
      const status = document.querySelector("#status");

      function loadScript(url) {
        return new Promise((resolve) => {
          const script = document.createElement("script");
          script.onload = () => resolve("JS glue code initialized ✅");
          script.onerror = () => resolve("Failed to load JS glue code ❌");
          script.type = "text/javascript";
          script.src = url;
          document.body.appendChild(script);
        });
      }

      function createWasmMemory(value) {
        const WASM_BLOCK_SIZE = 65536;
        const ONE_GIBIBYTE = 1024 * 1024 * 1024;

        return new WebAssembly.Memory({
          initial: (value * ONE_GIBIBYTE) / WASM_BLOCK_SIZE,
          maximum: (4 * ONE_GIBIBYTE) / WASM_BLOCK_SIZE,
          shared: true,
        });
      }

      async function runGlueLoader() {
        globalThis.Module = globalThis.Module || {};
        globalThis.Module.wasmMemory = createWasmMemory(memory.value);

        const result = await loadScript("/apollo_web.CxKogY9t.js");
        status.textContent = "";
        status.textContent += result;
        glueStatus.textContent = COMPLETE;
      }

      const wasmStatus = document.querySelector("#wasm-status");
      async function runWasmLoader() {
        doWasmLoad();
        await wasmRequest;
        status.textContent += " WASM loaded ✅";
        wasmStatus.textContent = COMPLETE;
      }

      let wasmRequest = undefined;
      const { promise: wasmShouldBeLoaded, resolve: doWasmLoad } =
        Promise.withResolvers();

      const originalFetch = fetch;
      window.fetch = async (...args) => {
        if (typeof args[0] === "string" && args[0].includes(".wasm")) {
          await wasmShouldBeLoaded;
          wasmRequest = originalFetch(...args);
          return wasmRequest;
        }

        return originalFetch(...args);
      };

      for (const [key, run] of Object.entries(autobootConfig)) {
        if (typeof run === "boolean") {
          const box = document.querySelector(`input#${key}`);
          box.checked = run;
        }

        if (key === "auto-glue" && run) {
          await runGlueLoader();
        }

        if (key === "auto-wasm" && run) {
          await runWasmLoader();
        }

        if (key === "auto-canvas" && run) {
          console.log("auto create canvas");
        }
      }

      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      for (const checkbox of checkboxes) {
        checkbox.addEventListener("click", (event) => {
          autobootConfig[event.target.id] = event.target.checked;
          localStorage.setItem(AUTOBOOT_KEY, JSON.stringify(autobootConfig));
        });
      }

      const clearAutoboot = document.querySelector("#clear-autoboot");
      clearAutoboot.addEventListener("click", () => {
        for (const box of checkboxes) {
          box.checked = false;
        }

        localStorage.setItem(
          AUTOBOOT_KEY,
          JSON.stringify({ ...DEFAULT_AUTOBOOT_CONFIG })
        );

        location.reload();
      });

      const loadGlue = document.querySelector("#load-glue");
      loadGlue.addEventListener("click", async () => {
        runGlueLoader();
      });

      const loadWasm = document.querySelector("#load-wasm");
      loadWasm.addEventListener("click", async () => {
        runWasmLoader();
      });

      const loadCanvas = document.querySelector("#load-canvas");
      loadCanvas.addEventListener("click", async () => {
        console.log("create canvas");
      });
    </script>
  </body>
</html>
