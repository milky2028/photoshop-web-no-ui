<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Photoshop Web Booter</title>
    <style>
      body {
        display: grid;
        justify-items: start;
        row-gap: 0.5rem;
      }

      * {
        font-family: Arial, Helvetica, sans-serif;
        box-sizing: border-box;
      }

      .divider {
        width: 100%;
        height: 2px;
        background-color: black;
      }
    </style>
  </head>
  <body>
    <div class="divider"></div>
    <div><strong>Status: </strong><span id="status">uninitialized</span></div>
    <div>
      <strong>crossOriginIsolated: </strong><span id="isolated">...</span>
    </div>
    <div class="divider"></div>
    <div>
      This application allows you to step through Photoshop Web's booting
      process with a pre-configured memory amount.
      <br />
      Use the checkbox next to each step to configure that step to run
      automatically on page reload.
    </div>
    <button id="clear-autoboot">Clear Autoboot</button>
    <div class="divider"></div>
    <label>
      <div>
        Initial WebAssembly Memory Allotment:
        <span id="configured-memory">...</span>GB
      </div>
      <input style="width: 300px" type="range" min="1" max="3.75" step="0.25" />
    </label>
    <div class="divider"></div>
    <div>Boot Process</div>
    <div>
      1.
      <input id="auto-memory" type="checkbox" />
      <button id="load-memory">Create WASM Memory</button>
      <span id="memory-status"></span>
    </div>
    <div>
      2.
      <input id="auto-glue" type="checkbox" />
      <button id="load-glue">Load Emscripten JS Glue Code</button>
      <span id="glue-status"></span>
    </div>
    <div>
      3.
      <input id="auto-wasm" type="checkbox" />
      <button id="load-wasm">Load WASM</button>
      <span id="wasm-status"></span>
    </div>
    <div>
      4.
      <input disabled id="auto-canvas" type="checkbox" />
      <button disabled id="load-canvas">Create and Attach Canvas</button>
      <span id="canvas-status"></span>
    </div>
    <div>
      5.
      <input disabled id="auto-file" type="checkbox" />
      <button disabled id="load-file">Import File and Open</button>
      <span id="file-status"></span>
    </div>
    <div>
      6.
      <input disabled id="auto-stroke" type="checkbox" />
      <button disabled id="load-stroke" disabled>Draw Brushstroke</button>
      <span id="stroke-status"></span>
    </div>
    <div class="divider"></div>
    <script type="module">
      import { loadWASM } from "/loadWASM.js";
      import { autobootConfig, DEFAULT_AUTOBOOT_CONFIG } from "/autoboot.js";
      import { loadScript } from "/loadScript.js";
      import { COMPLETE, FAILED, AUTOBOOT_KEY } from "/constants.js";
      import { createWasmMemory } from "/createWasmMemory.js";
      import { loadGlueCode } from "/loadGlueCode.js";

      const isolation = document.querySelector("#isolated");
      isolation.textContent = crossOriginIsolated;

      const memory = document.querySelector(`input[type="range"]`);
      const configuredMemory = document.querySelector("#configured-memory");

      memory.value = autobootConfig["auto-memory-amount"];
      configuredMemory.textContent = memory.value;
      memory.addEventListener("input", (event) => {
        configuredMemory.textContent = event.target.value;
        autobootConfig["auto-memory-amount"] = event.target.value;
        localStorage.setItem(AUTOBOOT_KEY, JSON.stringify(autobootConfig));
      });

      const canvasStatus = document.querySelector("#canvas-status");
      function createAndAttachCanvas() {
        const { height: bodyHeight, width: bodyWidth } =
          document.body.getBoundingClientRect();
        const remainingHeight = innerHeight - bodyHeight - 32;
        const canvas = document.createElement("canvas");
        canvas.style.border = "1px solid black";
        canvas.height = remainingHeight < 400 ? 400 : remainingHeight;
        canvas.width = bodyWidth;
        document.body.appendChild(canvas);
        canvasStatus.textContent = COMPLETE;
      }

      for (const [key, run] of Object.entries(autobootConfig)) {
        if (typeof run === "boolean") {
          const box = document.querySelector(`input#${key}`);
          box.checked = run;
        }

        if (key === "auto-memory" && run) {
          createWasmMemory(memory.value);
        }

        if (key === "auto-glue" && run) {
          await loadGlueCode();
        }

        if (key === "auto-wasm" && run) {
          await loadWASM();
        }

        if (key === "auto-canvas" && run) {
          createAndAttachCanvas();
        }
      }

      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      for (const checkbox of checkboxes) {
        checkbox.addEventListener("click", (event) => {
          autobootConfig[event.target.id] = event.target.checked;
          localStorage.setItem(AUTOBOOT_KEY, JSON.stringify(autobootConfig));
        });
      }

      const clearAutoboot = document.querySelector("#clear-autoboot");
      clearAutoboot.addEventListener("click", () => {
        for (const box of checkboxes) {
          box.checked = false;
        }

        localStorage.setItem(
          AUTOBOOT_KEY,
          JSON.stringify({ ...DEFAULT_AUTOBOOT_CONFIG })
        );

        location.reload();
      });

      const loadMemory = document.querySelector("#load-memory");
      loadMemory.addEventListener("click", async () => {
        createWasmMemory(memory.value);
      });

      const loadGlue = document.querySelector("#load-glue");
      loadGlue.addEventListener("click", async () => {
        await loadGlueCode();
      });

      const loadWasm = document.querySelector("#load-wasm");
      loadWasm.addEventListener("click", async () => {
        await runWasmLoader();
      });

      const loadCanvas = document.querySelector("#load-canvas");
      loadCanvas.addEventListener("click", async () => {
        createAndAttachCanvas();
      });
    </script>
  </body>
</html>
